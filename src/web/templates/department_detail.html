{% extends "base.html" %}
{% block title %}{{ department.name }} - SeeClickFix Sentiment{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ department.name }}</h1>
</div>

{% if summary %}
<div class="stats">
    <div class="stat">
        <span class="stat-value">{{ department.employee_count }}</span>
        <span class="stat-label">Employees</span>
    </div>
    <div class="stat">
        <span class="stat-value">{{ summary.analyzed_comments }}</span>
        <span class="stat-label">Issues</span>
    </div>
    <div class="stat">
        <span class="stat-value positive">{{ "%.0f"|format(summary.positive_pct or 0) }}%</span>
        <span class="stat-label">Positive</span>
    </div>
    <div class="stat">
        <span class="stat-value negative">{{ "%.0f"|format(summary.negative_pct or 0) }}%</span>
        <span class="stat-label">Negative</span>
    </div>
</div>

{% set pos = summary.positive_pct or 0 %}
{% set neg = summary.negative_pct or 0 %}
{% set neu = 100 - pos - neg %}
<div class="sentiment-bar sentiment-bar-lg">
    {% if pos > 0 %}<div class="segment segment-positive" style="width:{{ pos }}%"></div>{% endif %}
    {% if neu > 0 %}<div class="segment segment-neutral" style="width:{{ neu }}%"></div>{% endif %}
    {% if neg > 0 %}<div class="segment segment-negative" style="width:{{ neg }}%"></div>{% endif %}
</div>
<div class="bar-legend">
    <span class="sentiment sentiment-positive">{{ "%.0f"|format(pos) }}% positive</span>
    <span class="sentiment sentiment-neutral">{{ "%.0f"|format(neu) }}% neutral</span>
    <span class="sentiment sentiment-negative">{{ "%.0f"|format(neg) }}% negative</span>
</div>
{% endif %}

<section>
    <h2>Employees</h2>
    {% if employees %}
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Title</th>
                <th class="text-right">Issues</th>
                <th class="text-right">Positive</th>
                <th class="text-right">Negative</th>
                <th class="text-right">Score</th>
            </tr>
        </thead>
        <tbody>
            {% for e in employees %}
            <tr>
                <td><a href="/employees/{{ e.id }}">{{ e.name_parsed or e.name_raw }}</a></td>
                <td class="text-muted">{{ e.title_parsed or '-' }}</td>
                <td class="text-right text-muted">{{ e.analyzed_comments or 0 }}</td>
                <td class="text-right">
                    {% if e.positive_pct is not none %}
                    <span class="text-positive">{{ "%.0f"|format(e.positive_pct) }}%</span>
                    {% else %}<span class="text-muted">-</span>{% endif %}
                </td>
                <td class="text-right">
                    {% if e.negative_pct is not none %}
                    <span class="text-negative">{{ "%.0f"|format(e.negative_pct) }}%</span>
                    {% else %}<span class="text-muted">-</span>{% endif %}
                </td>
                <td class="text-right">
                    {% if e.avg_vader_compound is not none %}
                    {{ "%.2f"|format(e.avg_vader_compound) }}
                    {% else %}<span class="text-muted">-</span>{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty">No employees in this department.</p>
    {% endif %}
</section>

{% if recent_issues %}
<section>
    <h2>Recent Issues</h2>
    <table>
        <thead>
            <tr>
                <th>Issue</th>
                <th>Type</th>
                <th>Sentiment</th>
                <th>Status</th>
                <th>Date</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for i in recent_issues %}
            <tr>
                <td class="truncate"><a href="/issues/{{ i.id }}">{{ i.summary }}</a></td>
                <td class="text-muted">{{ i.request_type or '-' }}</td>
                <td>{% if i.resolved_label %}<span class="sentiment sentiment-{{ i.resolved_label }}">{{ i.resolved_label }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                <td><span class="status">{{ i.status }}</span></td>
                <td class="text-muted">{{ i.created_at[:10] if i.created_at else '' }}</td>
                <td>{% if i.html_url %}<a href="{{ i.html_url }}" target="_blank" rel="noopener" class="external">SCF</a>{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% endif %}
{% endblock %}
